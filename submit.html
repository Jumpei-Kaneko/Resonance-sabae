<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音を残す - Resonance</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>音を残す</h1>
        </header>
        <main>
            <p>あなたの好きな西山公園の音を、作品の一部として残してみませんか？</p>
            
            <div id="recorder-ui">
                <button id="record-button">録音開始</button>
                <button id="stop-button" disabled>録音停止</button>
            </div>

            <div id="preview-ui" style="display: none;">
                <p>録音した音声を確認してください：</p>
                <audio id="audio-preview" controls></audio>
                <button id="upload-button">この音を作品に残す</button>
            </div>

            <div id="status-message"></div>
            <a href="./index.html" class="back-link">メニューに戻る</a>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const recordButton = document.getElementById('record-button');
            const stopButton = document.getElementById('stop-button');
            const uploadButton = document.getElementById('upload-button');
            const audioPreview = document.getElementById('audio-preview');
            const statusMessage = document.getElementById('status-message');
            const recorderUI = document.getElementById('recorder-ui');
            const previewUI = document.getElementById('preview-ui');

            const uploadUrl = '【ここに、あなたのサーバーのアップロード用PHPのURLを記入】';

            let mediaRecorder;
            let audioChunks = [];
            let recordedAudioBlob = null;
            let mimeType = 'audio/webm'; // デフォルトの形式
            let fileExtension = 'webm'; // デフォルトの拡張子

            recordButton.addEventListener('click', async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // ★★★ iPhone対応のための修正 ★★★
                    // 'audio/mp4'形式が使えるか確認
                    if (MediaRecorder.isTypeSupported('audio/mp4')) {
                        mimeType = 'audio/mp4';
                        fileExtension = 'mp4';
                    } else {
                        // 使えなければデフォルトのwebmのまま
                        mimeType = 'audio/webm';
                        fileExtension = 'webm';
                    }
                    console.log('Using mimeType:', mimeType);
                    // ★★★ ここまで ★★★

                    mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
                    audioChunks = [];

                    mediaRecorder.addEventListener('start', () => {
                        recordButton.disabled = true;
                        stopButton.disabled = false;
                        statusMessage.textContent = '録音中...（30秒で自動停止します）';
                    });

                    mediaRecorder.addEventListener('dataavailable', event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener('stop', () => {
                        recordedAudioBlob = new Blob(audioChunks, { type: mimeType });
                        const audioUrl = URL.createObjectURL(recordedAudioBlob);
                        audioPreview.src = audioUrl;

                        recorderUI.style.display = 'none';
                        previewUI.style.display = 'block';
                        statusMessage.textContent = '録音が完了しました。';
                        
                        stream.getTracks().forEach(track => track.stop());
                    });
                    
                    mediaRecorder.start();

                    setTimeout(() => {
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                        }
                    }, 30000);

                } catch (err) {
                    console.error('マイクへのアクセスエラー:', err);
                    statusMessage.textContent = 'エラー：マイクへのアクセスが許可されませんでした。';
                }
            });

            stopButton.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
            });

            uploadButton.addEventListener('click', () => {
                if (!recordedAudioBlob) return;

                statusMessage.textContent = 'アップロード中...';
                const formData = new FormData();
                // ファイル名に正しい拡張子を設定
                formData.append('audio_file', recordedAudioBlob, `recording.${fileExtension}`);

                fetch(uploadUrl, {
                    method: 'POST',
                    body: formData,
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('アップロードに失敗しました。');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('アップロード成功:', data);
                    statusMessage.textContent = 'あなたの音を、作品に残しました。ありがとうございます。';
                    uploadButton.disabled = true;
                })
                .catch(error => {
                    console.error('アップロードエラー:', error);
                    statusMessage.textContent = 'エラー：アップロードに失敗しました。';
                });
            });
        });
    </script>
</body>
</html>
